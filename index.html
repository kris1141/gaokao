<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>重庆高考录取预测系统</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="page">
    <section class="hero">
      <p class="eyebrow">CHONGQING · GAOKAO · 2025 DATA</p>
      <h1>重庆高考录取预测系统</h1>
      <p class="hero-desc">位次驱动的录取概率分析，支持冲稳保推荐与关键词查找。</p>
      <div class="hero-tags">
        <span>位次换算</span>
        <span>智能推荐</span>
        <span>关键词查找</span>
      </div>
      <div class="hero-grid">
        <div><p>预测核心</p><strong>位次比模型</strong></div>
        <div><p>数据范围</p><strong>2025 重庆本科批</strong></div>
        <div><p>填报策略</p><strong>冲 / 稳 / 保</strong></div>
      </div>
    </section>

    <section class="card form-card">
      <div class="card-head">
        <h2>预测参数</h2>
        <p>普通类填分数或位次；艺术类填写文化成绩和艺考成绩后自动换算综合分。</p>
      </div>
      <form method="post">
        <div class="grid grid-3">
          <label>
            <span>科类</span>
            <select name="stream" id="stream-select">
              <option value="历史" {% if form.stream == "历史" %}selected{% endif %}>历史类</option>
              <option value="物理" {% if form.stream == "物理" %}selected{% endif %}>物理类</option>
              <option value="艺术" {% if form.stream == "艺术" %}selected{% endif %}>艺术类</option>
            </select>
          </label>
          <label class="normal-only">
            <span id="score-label">分数（可选）</span>
            <input name="score" type="number" step="0.01" placeholder="普通类填高考分；艺术类可填综合分" value="{{ form.score }}">
          </label>
          <label>
            <span>位次（可选）</span>
            <input name="rank" type="number" placeholder="例如 5000" value="{{ form.rank }}">
          </label>
          <div class="art-panel art-only is-hidden span-3">
            <div class="art-grid">
              <label>
                <span>文化素质测试和技术科目测试总成绩（满分750）</span>
                <input name="art_culture_score" id="art-culture-score" type="number" step="0.01" placeholder="例如 520" value="{{ form.art_culture_score }}">
              </label>
              <label>
                <span>艺考统考成绩</span>
                <input name="art_special_score" id="art-special-score" type="number" step="0.01" placeholder="例如 245.5" value="{{ form.art_special_score }}">
              </label>
              <label>
                <span>综合分（自动换算）</span>
                <input id="art-composite-preview" type="text" readonly placeholder="输入后自动计算">
              </label>
            </div>
            <p class="formula-note">
              综合分 = (文化素质测试和技术科目测试总成绩/750*300*50%) + 专业统考成绩*50%，四舍五入保留两位；
              同分比较顺序：语文、数学、英语、信息及通用技术。
            </p>
          </div>
          <label>
            <span>推荐条数</span>
            <input name="top_n" type="number" min="10" max="200" value="{{ form.top_n }}">
          </label>
          <label>
            <span>院校关键词</span>
            <input name="school_keyword" placeholder="例如 重庆大学" value="{{ form.school_keyword }}">
          </label>
          <label>
            <span>专业关键词</span>
            <input name="major_keyword" placeholder="例如 计算机" value="{{ form.major_keyword }}">
          </label>
          <label class="span-3">
            <span>地域关键词（按院校名筛选）</span>
            <input name="region_keyword" placeholder="例如 北京 / 上海" value="{{ form.region_keyword }}">
          </label>
        </div>

        <div class="action-row">
          <button type="submit">开始预测</button>
          <p>提示：支持院校、专业、地域关键词快速筛选。</p>
        </div>
      </form>
    </section>

    {% if error %}
    <section class="card error-card">
      <h2>输入错误</h2>
      <p>{{ error }}</p>
    </section>
    {% endif %}

    {% if result %}
    <section class="card">
      <div class="card-head">
        <h2>结果总览</h2>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <p class="kpi-label">科类</p>
          <p class="kpi-value">{{ result.stream }}</p>
        </div>
        <div class="kpi">
          <p class="kpi-label">换算位次</p>
          <p class="kpi-value">{{ result.user_rank }}</p>
        </div>
        <div class="kpi">
          {% if result.stream == "艺术" %}
          <p class="kpi-label">艺术综合分</p>
          <p class="kpi-value">{{ result.used_score_display if result.used_score_display is not none else "-" }}</p>
          {% else %}
          <p class="kpi-label">输入分数</p>
          <p class="kpi-value">{{ result.score_display if result.score_display is not none else "-" }}</p>
          {% endif %}
        </div>
        <div class="kpi">
          <p class="kpi-label">模式</p>
          {% if result.has_keyword_search %}
          <p class="kpi-value">关键词查找</p>
          {% else %}
          <p class="kpi-value">智能推荐</p>
          {% endif %}
        </div>
        <div class="kpi">
          <p class="kpi-label">最低概率</p>
          <p class="kpi-value">自动评估</p>
        </div>
      </div>
      <div class="tier-row">
        <button type="button" class="tier-filter active" data-tier-filter="全部" aria-pressed="true">全部 {{ result.recommendations|length }}</button>
        <button type="button" class="tier-filter crash" data-tier-filter="冲" aria-pressed="false">冲 {{ result.tier_stats["冲"] }}</button>
        <button type="button" class="tier-filter steady" data-tier-filter="稳" aria-pressed="false">稳 {{ result.tier_stats["稳"] }}</button>
        <button type="button" class="tier-filter safe" data-tier-filter="保" aria-pressed="false">保 {{ result.tier_stats["保"] }}</button>
      </div>
      <p class="tier-filter-status" id="tier-filter-status">当前显示：全部</p>
      <div class="prob-guide">
        {% for item in result.probability_guide %}
        <div class="guide-item">
          <p>{{ "%.0f%%"|format(item.min * 100) }}+</p>
          <strong>{{ item.label }}</strong>
          <span>{{ item.desc }}</span>
        </div>
        {% endfor %}
      </div>
    </section>

    <section class="card">
      <div class="card-head">
        <h2>智能推荐列表</h2>
        <p>鼠标停在概率上可查看解释，便于家长理解风险等级。</p>
      </div>
      {% if result.recommendations %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>院校代码</th>
              <th>院校名称</th>
              <th>专业代码</th>
              <th>专业名称</th>
              <th>最低分</th>
              <th>最低位次</th>
              <th>位次比</th>
              <th>分档</th>
              <th>概率</th>
            </tr>
          </thead>
          <tbody>
          {% for row in result.recommendations %}
            <tr data-tier="{{ row.tier }}">
              <td data-label="院校代码">{{ row.school_code }}</td>
              <td data-label="院校名称">{{ row.school_name }}</td>
              <td data-label="专业代码">{{ row.major_code }}</td>
              <td data-label="专业名称">{{ row.major_name }}</td>
              <td data-label="最低分">{{ row.min_score }}</td>
              <td data-label="最低位次">{{ row.min_rank }}</td>
              <td data-label="位次比">{{ "%.4f"|format(row.rank_ratio) }}</td>
              <td data-label="分档"><span class="tier-pill {{ 'tier-safe' if row.tier == '保' else ('tier-steady' if row.tier == '稳' else 'tier-crash') }}">{{ row.tier }}</span></td>
              <td data-label="概率"><span class="prob-chip" data-tip="{{ row.probability_desc }}" title="{{ row.probability_desc }}">{{ "%.1f%%"|format(row.probability * 100) }}</span></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">没有符合当前条件的结果，请调整筛选条件。</p>
      {% endif %}
    </section>

    {% endif %}
  </main>
  <script>
    (function () {
      const streamSelect = document.getElementById("stream-select");
      const scoreLabel = document.getElementById("score-label");
      const scoreInput = document.querySelector("input[name='score']");
      const artCultureInput = document.getElementById("art-culture-score");
      const artSpecialInput = document.getElementById("art-special-score");
      const artCompositePreview = document.getElementById("art-composite-preview");
      const artOnly = document.querySelectorAll(".art-only");
      const normalOnly = document.querySelectorAll(".normal-only");

      function roundHalfUp(value, digits) {
        const factor = Math.pow(10, digits);
        return Math.round((value + Number.EPSILON) * factor) / factor;
      }

      function calcComposite() {
        if (!artCultureInput || !artSpecialInput || !artCompositePreview) {
          return;
        }
        const culture = Number(artCultureInput.value);
        const special = Number(artSpecialInput.value);
        if (!Number.isFinite(culture) || !Number.isFinite(special)) {
          artCompositePreview.value = "";
          return;
        }
        let composite = (culture / 750) * 300 * 0.5 + special * 0.5;
        composite = roundHalfUp(composite, 2);
        artCompositePreview.value = composite.toFixed(2);
        if (scoreInput) {
          scoreInput.value = composite.toFixed(2);
        }
      }

      function refreshArtForm() {
        const isArt = streamSelect && streamSelect.value === "艺术";
        artOnly.forEach((el) => {
          el.classList.toggle("is-hidden", !isArt);
        });
        normalOnly.forEach((el) => {
          el.classList.toggle("is-hidden", isArt);
        });
        if (!isArt) {
          if (scoreLabel) {
            scoreLabel.textContent = "分数（可选）";
          }
          return;
        }
        if (scoreLabel) {
          scoreLabel.textContent = "综合分（可选，可由下方自动换算）";
        }
        calcComposite();
      }

      if (streamSelect) {
        streamSelect.addEventListener("change", refreshArtForm);
      }
      if (artCultureInput) {
        artCultureInput.addEventListener("input", calcComposite);
      }
      if (artSpecialInput) {
        artSpecialInput.addEventListener("input", calcComposite);
      }
      refreshArtForm();

      const tierButtons = document.querySelectorAll("[data-tier-filter]");
      const tierRows = document.querySelectorAll("tr[data-tier]");
      const tierStatus = document.getElementById("tier-filter-status");

      function applyTierFilter(tier) {
        let visibleCount = 0;
        tierRows.forEach((row) => {
          const matched = tier === "全部" || row.dataset.tier === tier;
          row.classList.toggle("is-row-hidden", !matched);
          if (matched) {
            visibleCount += 1;
          }
        });
        tierButtons.forEach((btn) => {
          const active = btn.dataset.tierFilter === tier;
          btn.classList.toggle("active", active);
          btn.setAttribute("aria-pressed", active ? "true" : "false");
        });
        if (tierStatus) {
          tierStatus.textContent = "当前显示：" + tier + "（" + visibleCount + "条）";
        }
      }

      tierButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          applyTierFilter(btn.dataset.tierFilter);
        });
      });
      if (tierButtons.length && tierRows.length) {
        applyTierFilter("全部");
      }
    })();
  </script>
</body>
</html>
